<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Horizon Drive — Accelerometer Controls</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0014;
    color: #e0d0ff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* ── Launcher screen ── */
  #launcher {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    padding: 2rem 1.5rem;
    text-align: center;
    background: linear-gradient(180deg, #12002a 0%, #1a0040 40%, #2d0060 100%);
  }

  h1 {
    font-size: 1.8rem;
    margin-bottom: .25rem;
    background: linear-gradient(135deg, #ff6ec7, #ffd700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .subtitle {
    font-size: .9rem;
    opacity: .6;
    margin-bottom: 2rem;
  }

  .card {
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.25rem;
    width: 100%;
    max-width: 420px;
  }

  .card h2 {
    font-size: 1.05rem;
    margin-bottom: .5rem;
    color: #ffd700;
  }

  .card p, .card li {
    font-size: .85rem;
    line-height: 1.5;
    opacity: .8;
  }

  .card ol {
    padding-left: 1.25rem;
    text-align: left;
  }

  .card li { margin-bottom: .35rem; }

  .btn {
    display: inline-block;
    padding: .85rem 2rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform .15s, box-shadow .15s;
    text-decoration: none;
  }

  .btn:active { transform: scale(.96); }

  .btn-primary {
    background: linear-gradient(135deg, #ff6ec7, #ff3cac);
    color: #fff;
    box-shadow: 0 4px 20px rgba(255,60,172,.4);
    margin-bottom: 1rem;
  }

  .btn-secondary {
    background: rgba(255,255,255,.08);
    color: #e0d0ff;
    border: 1px solid rgba(255,255,255,.15);
    font-size: .85rem;
    padding: .65rem 1.5rem;
  }

  .or-divider {
    font-size: .8rem;
    opacity: .4;
    margin: .75rem 0;
  }

  /* ── Console snippet view ── */
  #snippet-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100dvh;
    padding: 2rem 1.5rem;
    background: linear-gradient(180deg, #12002a 0%, #1a0040 100%);
  }

  #snippet-screen h2 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: #ffd700;
  }

  .snippet-steps {
    width: 100%;
    max-width: 500px;
    text-align: left;
  }

  .snippet-steps li {
    font-size: .85rem;
    margin-bottom: .75rem;
    line-height: 1.5;
    list-style: none;
    padding-left: 1.75rem;
    position: relative;
  }

  .snippet-steps li::before {
    content: attr(data-step);
    position: absolute;
    left: 0;
    color: #ff6ec7;
    font-weight: 700;
  }

  pre.snippet-code {
    width: 100%;
    max-width: 500px;
    background: rgba(0,0,0,.4);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 12px;
    padding: 1rem;
    margin: 1rem 0;
    overflow-x: auto;
    font-size: .7rem;
    line-height: 1.4;
    color: #c8b8e8;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .copy-btn {
    background: linear-gradient(135deg, #ff6ec7, #ff3cac);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: .7rem 1.5rem;
    font-size: .9rem;
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 1rem;
  }

  .back-btn {
    background: none;
    border: 1px solid rgba(255,255,255,.15);
    color: #e0d0ff;
    border-radius: 10px;
    padding: .5rem 1.25rem;
    font-size: .8rem;
    cursor: pointer;
  }

  .status-badge {
    display: inline-block;
    padding: .25rem .6rem;
    border-radius: 6px;
    font-size: .7rem;
    font-weight: 600;
    margin-top: .5rem;
  }

  .status-badge.found { background: rgba(0,200,0,.2); color: #4f4; }
  .status-badge.missing { background: rgba(255,60,60,.2); color: #f66; }
</style>
</head>
<body>

<!-- ═══════════════════════ LAUNCHER ═══════════════════════ -->
<div id="launcher">
  <h1>Horizon Drive</h1>
  <p class="subtitle">Accelerometer Steering Controller</p>

  <div class="card">
    <h2>How it works</h2>
    <ol>
      <li>Open the game link below on your phone</li>
      <li>Paste the controller script into your browser console</li>
      <li>Tilt your phone left/right to steer</li>
      <li>Gas pedal button is pressed automatically</li>
    </ol>
  </div>

  <div class="card">
    <h2>Why console injection?</h2>
    <p>The game runs on Shopify's domain and uses touch buttons for controls.
       The script runs inside the game page so it can directly press those
       buttons based on your phone's accelerometer tilt.</p>
  </div>

  <button class="btn btn-primary" id="btn-show-snippet">
    Get Controller Script
  </button>

  <p class="or-divider" style="margin-top:.5rem;">
    <a href="https://www.shopify.com/editions/summer2025/drive"
       target="_blank" rel="noopener"
       style="color:#ff6ec7;font-size:.85rem;">
      Open Horizon Drive
    </a>
  </p>
</div>

<!-- ═══════════════════════ SNIPPET SCREEN ═══════════════════════ -->
<div id="snippet-screen">
  <h2>Controller Script</h2>
  <ul class="snippet-steps">
    <li data-step="1.">Open the game:
      <a href="https://www.shopify.com/editions/summer2025/drive"
         target="_blank" rel="noopener" style="color:#ff6ec7;">
        Horizon Drive
      </a>
    </li>
    <li data-step="2.">Open browser DevTools console
      <br><em style="font-size:.75rem;opacity:.6;">
        Desktop: F12 → Console.
        iOS: Settings → Safari → Advanced → Web Inspector, then connect Mac Safari.
        Android: chrome://inspect from desktop Chrome.
      </em>
    </li>
    <li data-step="3.">Paste the script below and press Enter</li>
    <li data-step="4.">Allow accelerometer access if prompted (iOS)</li>
  </ul>
  <pre class="snippet-code" id="snippet-code"></pre>
  <button class="copy-btn" id="btn-copy-snippet">Copy Script</button>
  <button class="back-btn" id="btn-snippet-back">Back</button>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════
// Controller script — runs INSIDE the Horizon Drive game page.
// Finds the actual touch-control button elements in the DOM, then
// uses DeviceOrientation (gamma) to simulate pointerdown/pointerup
// on the left/right steer buttons, and holds gas perpetually.
// ═══════════════════════════════════════════════════════════════════

const CONTROLLER_SCRIPT = `(function(){
if(window.__accelDriveActive){console.log('Accel-Drive already running.');return;}
window.__accelDriveActive=true;

/* ═══ Configuration ═══ */
var DEAD_ZONE=5;
var SENSITIVITY=12;
var calibration=0;

/* ═══ State ═══ */
var currentSteering='none'; /* 'left' | 'right' | 'none' */
var latestGamma=0;
var controls=null; /* {left, right, gas} DOM elements */

/* ═══ Pointer-event helpers ═══ */
function ptrOpts(el){
  var r=el.getBoundingClientRect();
  return {
    bubbles:true,cancelable:true,
    clientX:r.left+r.width/2,
    clientY:r.top+r.height/2,
    pointerId:1,pointerType:'touch',
    isPrimary:true,width:1,height:1,pressure:0.5
  };
}
function pointerDown(el){
  if(!el)return;
  var o=ptrOpts(el);
  el.dispatchEvent(new PointerEvent('pointerdown',o));
  /* also fire touch events for frameworks that listen on those */
  try{
    var t=new Touch({identifier:Date.now(),target:el,clientX:o.clientX,clientY:o.clientY,
      pageX:o.clientX,pageY:o.clientY,radiusX:1,radiusY:1});
    el.dispatchEvent(new TouchEvent('touchstart',{bubbles:true,cancelable:true,touches:[t],targetTouches:[t],changedTouches:[t]}));
  }catch(e){}
}
function pointerUp(el){
  if(!el)return;
  var o=ptrOpts(el);
  el.dispatchEvent(new PointerEvent('pointerup',o));
  try{
    var t=new Touch({identifier:Date.now(),target:el,clientX:o.clientX,clientY:o.clientY,
      pageX:o.clientX,pageY:o.clientY,radiusX:1,radiusY:1});
    el.dispatchEvent(new TouchEvent('touchend',{bubbles:true,cancelable:true,touches:[],targetTouches:[],changedTouches:[t]}));
  }catch(e){}
}

/* ═══ Find game control buttons ═══ */
function findControls(){
  var vh=window.innerHeight;
  var vw=window.innerWidth;
  var cutoff=vh*0.65; /* buttons are in the bottom ~35% */

  /* Gather ALL leaf-ish elements in the bottom zone */
  var all=document.querySelectorAll('button, div, span, a, svg, [role="button"]');
  var candidates=[];
  for(var i=0;i<all.length;i++){
    var el=all[i];
    var r=el.getBoundingClientRect();
    /* Must be visible, in the bottom zone, and button-sized */
    if(r.top>=cutoff && r.width>=35 && r.height>=35 && r.width<vw*0.35 && r.height<vh*0.25){
      /* skip elements that contain other candidate-sized children */
      candidates.push({el:el,r:r,cx:r.left+r.width/2,cy:r.top+r.height/2});
    }
  }
  if(candidates.length===0){console.warn('Accel-Drive: no control buttons found');return null;}

  /* De-duplicate overlapping elements — keep innermost (smallest area) */
  candidates.sort(function(a,b){return(a.r.width*a.r.height)-(b.r.width*b.r.height);});
  var kept=[];
  for(var i=0;i<candidates.length;i++){
    var dominated=false;
    for(var j=0;j<kept.length;j++){
      var dx=Math.abs(candidates[i].cx-kept[j].cx);
      var dy=Math.abs(candidates[i].cy-kept[j].cy);
      if(dx<20&&dy<20){dominated=true;break;}
    }
    if(!dominated)kept.push(candidates[i]);
  }

  /* Sort left-to-right by center x */
  kept.sort(function(a,b){return a.cx-b.cx;});

  /* Expect 4 buttons: [left_steer, right_steer, brake, gas] */
  /* or at least identify left-half vs right-half */
  var mid=vw/2;
  var leftSide=kept.filter(function(c){return c.cx<mid;});
  var rightSide=kept.filter(function(c){return c.cx>=mid;});

  leftSide.sort(function(a,b){return a.cx-b.cx;});
  rightSide.sort(function(a,b){return a.cx-b.cx;});

  var result={
    left: leftSide.length>=1 ? leftSide[0].el : null,
    right: leftSide.length>=2 ? leftSide[1].el : null,
    gas: rightSide.length>=1 ? rightSide[rightSide.length-1].el : null
  };

  console.log('Accel-Drive controls found:',
    'LEFT=',result.left,
    'RIGHT=',result.right,
    'GAS=',result.gas);
  return result;
}

/* ═══ Gas: hold the rightmost button perpetually ═══ */
var gasHeld=false;
function holdGas(){
  if(!controls||!controls.gas)return;
  if(!gasHeld){
    pointerDown(controls.gas);
    gasHeld=true;
  }
}
/* Re-press gas periodically to fight any auto-release the game may do */
var gasInterval=setInterval(function(){
  if(!controls){controls=findControls();}
  if(!controls||!controls.gas)return;
  /* release and re-press to keep it alive */
  pointerUp(controls.gas);
  pointerDown(controls.gas);
  gasHeld=true;
},200);

/* ═══ Steering ═══ */
function updateSteering(gamma){
  var adjusted=gamma-calibration;
  var dir='none';
  if(adjusted<-DEAD_ZONE)dir='left';
  else if(adjusted>DEAD_ZONE)dir='right';

  if(dir===currentSteering)return;

  if(!controls){controls=findControls();}
  if(!controls)return;

  /* Release previous */
  if(currentSteering==='left'&&controls.left) pointerUp(controls.left);
  if(currentSteering==='right'&&controls.right) pointerUp(controls.right);

  /* Press new */
  if(dir==='left'&&controls.left) pointerDown(controls.left);
  if(dir==='right'&&controls.right) pointerDown(controls.right);

  currentSteering=dir;
  updateHUD(adjusted,dir);
}

/* ═══ HUD overlay ═══ */
var hud=document.createElement('div');
hud.id='accel-hud';
hud.innerHTML='<div style=\"position:fixed;top:0;left:0;right:0;z-index:99999;'+
  'display:flex;align-items:center;justify-content:space-between;'+
  'background:rgba(0,0,0,.55);backdrop-filter:blur(6px);'+
  'padding:5px 10px;font-family:system-ui;font-size:11px;color:#fff;\">'+
  '<span id=\"ah-dir\" style=\"min-width:60px;font-weight:700;text-align:center;\">STRAIGHT</span>'+
  '<span style=\"display:flex;align-items:center;gap:4px;\">'+
    '<span style=\"font-size:9px;opacity:.5;\">Tilt</span>'+
    '<span id=\"ah-gamma\" style=\"min-width:32px;text-align:right;\">0\\u00b0</span>'+
  '</span>'+
  '<span style=\"color:#4f4;font-weight:700;\">GAS ON</span>'+
  '<span style=\"display:flex;align-items:center;gap:3px;font-size:9px;\">'+
    'Sens <input id=\"ah-sens\" type=\"range\" min=\"3\" max=\"30\" value=\"12\" style=\"width:45px;accent-color:#ff6ec7;\">'+
  '</span>'+
  '<button id=\"ah-cal\" style=\"background:rgba(255,255,255,.15);border:none;color:#fff;'+
    'border-radius:5px;padding:2px 7px;font-size:9px;cursor:pointer;\">Zero</button>'+
  '<button id=\"ah-rescan\" style=\"background:rgba(100,100,255,.3);border:none;color:#fff;'+
    'border-radius:5px;padding:2px 7px;font-size:9px;cursor:pointer;\">Rescan</button>'+
  '<button id=\"ah-stop\" style=\"background:rgba(255,60,60,.4);border:none;color:#fff;'+
    'border-radius:5px;padding:2px 7px;font-size:9px;cursor:pointer;\">Stop</button>'+
'</div>';
document.body.appendChild(hud);

function updateHUD(adjusted,dir){
  var el=document.getElementById('ah-dir');
  if(el)el.textContent=dir==='left'?'<< LEFT':dir==='right'?'RIGHT >>':'STRAIGHT';
  var ge=document.getElementById('ah-gamma');
  if(ge)ge.textContent=Math.round(adjusted)+'\\u00b0';
}

/* Wire up HUD buttons after DOM append */
setTimeout(function(){
  var sl=document.getElementById('ah-sens');
  if(sl)sl.addEventListener('input',function(){SENSITIVITY=+this.value;DEAD_ZONE=Math.max(2,SENSITIVITY/3);});

  var cal=document.getElementById('ah-cal');
  if(cal)cal.addEventListener('click',function(){calibration=latestGamma;});

  var rescan=document.getElementById('ah-rescan');
  if(rescan)rescan.addEventListener('click',function(){
    controls=findControls();
    if(controls)console.log('Rescan done. Controls:',controls);
    else console.warn('Rescan: no controls found');
  });

  var stop=document.getElementById('ah-stop');
  if(stop)stop.addEventListener('click',function(){
    clearInterval(gasInterval);
    if(controls){
      if(controls.gas)pointerUp(controls.gas);
      if(controls.left)pointerUp(controls.left);
      if(controls.right)pointerUp(controls.right);
    }
    window.removeEventListener('deviceorientation',onOrientation);
    hud.remove();
    window.__accelDriveActive=false;
    console.log('Accel-Drive stopped.');
  });
},50);

/* ═══ Accelerometer ═══ */
function onOrientation(e){
  latestGamma=e.gamma||0;
  updateSteering(latestGamma);
}

/* iOS 13+ requires user-gesture permission request */
if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
  DeviceOrientationEvent.requestPermission().then(function(state){
    if(state==='granted'){
      window.addEventListener('deviceorientation',onOrientation);
      console.log('Accelerometer permission granted.');
    } else {
      console.warn('Accelerometer permission denied.');
    }
  }).catch(function(err){console.error('Accel permission error:',err);});
} else {
  window.addEventListener('deviceorientation',onOrientation);
}

/* ═══ Initial control scan (retry a few times in case game is still loading) ═══ */
var scanAttempts=0;
var scanTimer=setInterval(function(){
  controls=findControls();
  scanAttempts++;
  if(controls||scanAttempts>=10)clearInterval(scanTimer);
},1000);

console.log('Accel-Drive v2 starting — scanning for game buttons...');
})();`;

// ── Populate snippet display ──
document.getElementById('snippet-code').textContent = CONTROLLER_SCRIPT;

// ═══════════════════════════════════════════════════════════
// UI Logic
// ═══════════════════════════════════════════════════════════

document.getElementById('btn-show-snippet').addEventListener('click', () => {
  document.getElementById('launcher').style.display = 'none';
  document.getElementById('snippet-screen').style.display = 'flex';
});

document.getElementById('btn-snippet-back').addEventListener('click', () => {
  document.getElementById('snippet-screen').style.display = 'none';
  document.getElementById('launcher').style.display = 'flex';
});

document.getElementById('btn-copy-snippet').addEventListener('click', () => {
  navigator.clipboard.writeText(CONTROLLER_SCRIPT).then(() => {
    const btn = document.getElementById('btn-copy-snippet');
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy Script'; }, 1500);
  });
});

</script>
</body>
</html>
